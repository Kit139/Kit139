"use strict";importScripts("//h5.sinaimg.cn/m/weibo-lite/manifest.142e6b4d502a2a0cdd17a58d42f4cd19.js","//h5.sinaimg.cn/m/weibo-lite/workbox-v3.6.3/workbox-sw.js"),workbox.setConfig({modulePathPrefix:"//h5.sinaimg.cn/m/weibo-lite/workbox-v3.6.3"}),workbox.googleAnalytics.initialize(),workbox.skipWaiting(),workbox.clientsClaim(),workbox.core.setCacheNameDetails({prefix:"mweibo-lite",precache:"install-time",runtime:"run-time",googleAnalytics:"ga"});var checkUpdateCaches=["localhost","chunks-v2"];function urlHashFilter(e){var n=new URL(e),t=n.pathname.split(".");if(2<t.length){e=t.splice(-2,1)[0];return[n.origin+t.join("."),e]}return[n.origin+t.join("."),""]}function traverseCaches(t){caches.keys().then(function(e){e.filter(function(e){return checkUpdateCaches.includes(e)}).map(function(e){return caches.open(e).then(function(n){n.keys().then(function(e){e.map(function(e){t(e,n)})})})})})}function handlerUpdateChunks(e){var n=e.url,s=e.event,o=(e.params,s.request);return caches.match(o).then(function(t){var e;return"js.intra.weibo.cn"===n.host?(e=new Request(n),t&&fetch(e).then(function(e){var n=t.headers.get("last-modified"),e=e.headers.get("last-modified");console.log(o.url,"last-modified:",n,e),n!==e&&traverseCaches(function(e,n){console.log("[SW:]Chunk has updated"),n.delete(e)})})):t||traverseCaches(function(e,n){var t=urlHashFilter(e.url),s=urlHashFilter(o.url);s[0]===t[0]&&s[1]!==t[1]&&n.delete(e)}),workbox.strategies.cacheFirst({cacheName:"chunks-v2",plugins:[new workbox.cacheableResponse.Plugin({statuses:[0,200]}),{requestWillFetch:function(e){e=e.request;return e=new Request(e.url)},cachedResponseWillBeUsed:function(e){return e.cachedResponse&&"opaque"===e.cachedResponse.type?(caches.delete(e.cacheName),null):e.cachedResponse}}]}).handle({event:s}).catch(function(e){console.error(e)})})}workbox.routing.registerRoute(new RegExp(/^https?:\/\/((h5\.sinaimg)|(js\.intra\.weibo))\.cn\/m\/(.*)\.(js|css)$/),handlerUpdateChunks),workbox.routing.registerRoute(new RegExp(/^https?:\/\/h5\.sinaimg\.cn\/(.*)\.(png|gif|jpg)$/),workbox.strategies.cacheFirst({cacheName:"images",plugins:[new workbox.expiration.Plugin({maxAgeSeconds:604800,maxEntries:30}),new workbox.cacheableResponse.Plugin({statuses:[0,200]}),{requestWillFetch:function(e){e=e.request;return e=new Request(e.url)},cachedResponseWillBeUsed:function(e){return e.cachedResponse&&"opaque"===e.cachedResponse.type?(caches.delete(e.cacheName),null):e.cachedResponse}}]})),workbox.routing.registerRoute(new RegExp(/^https?:\/\/((h5\.sinaimg)|(css\.intra\.weibo))\.cn\/marvel\/(.*)\.(js|css)$/),workbox.strategies.cacheFirst({cacheName:"statics",plugins:[new workbox.expiration.Plugin({maxAgeSeconds:172800}),new workbox.cacheableResponse.Plugin({statuses:[0,200]}),{requestWillFetch:function(e){e=e.request;return e=new Request(e.url)},cachedResponseWillBeUsed:function(e){return e.cachedResponse&&"opaque"===e.cachedResponse.type?(caches.delete(e.cacheName),null):e.cachedResponse}}]}));var bgSyncPlugin=new workbox.backgroundSync.Plugin("weibo",{maxRetentionTime:1440});function handlerUpdateAPI(e){var n=e.url,t=e.event,s=(e.params,new URL(n).searchParams),n=!s.toString(),o=!1;if(!n){var r=!0,i=!1,a=void 0;try{for(var c=s.keys()[Symbol.iterator]();!(r=(l=c.next()).done);r=!0){var l=l.value;if(/id$/.test(l)||"page"===l){o=!0;break}}}catch(e){i=!0,a=e}finally{try{!r&&c.return&&c.return()}finally{if(i)throw a}}}return-1<t.request.headers.get("accept").indexOf("application/json")&&(o||n)?workbox.strategies.networkFirst({cacheName:"api",plugins:[new workbox.expiration.Plugin({maxEntries:20,maxAgeSeconds:86400}),bgSyncPlugin]}).handle({event:t}).catch(function(e){console.error(e)}):-1<t.request.headers.get("accept").indexOf("text/html")?workbox.strategies.staleWhileRevalidate({cacheName:"page",plugins:[new workbox.expiration.Plugin({maxEntries:20,maxAgeSeconds:86400}),bgSyncPlugin]}).handle({event:t}).catch(function(){caches.match(location.origin)}):workbox.strategies.networkOnly({plugins:[{requestWillFetch:function(e){e=e.request;return e=new Request(e,{mode:"same-origin"})}}]}).handle({event:t}).catch(function(e){console.error(e)})}function sendMessageToAllClients(n){self.clients.matchAll().then(function(e){e.forEach(function(e){e.postMessage(n)})})}function sendMessageToClientsAsync(e){setTimeout(function(){sendMessageToAllClients(e)},1e3)}workbox.routing.registerRoute(new RegExp("^https://m.weibo.cn/.*"),handlerUpdateAPI),self.addEventListener("sync",function(n){n.waitUntil(self.clients.matchAll().then(function(e){return e.map(function(e){return console.info("send a message"),e.postMessage(n.tag)})}).catch(function(e){console.error(e)}))}),self.addEventListener("activate",function(e){e.waitUntil(caches.keys().then(function(e){return Promise.all(e.filter(function(e){return"page"===e}).map(function(e){return caches.delete(e)}))})),sendMessageToClientsAsync({command:"UPDATE_FOUND"})}),self.addEventListener("error",function(e){console.error("出错"),console.dir(e)}),self.addEventListener("unhandledrejection",function(e){console.error("Promise出错"),console.dir(e)}),self.addEventListener("message",function(e){console.error(e.data)});